{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Local Popularity — Map</h1>
    <a class="btn btn-outline-secondary" href="{% url 'cart.popularity' %}">View as list</a>
  </div>
  <p class="text-muted">Click a ZIP marker to view that region’s top movies.</p>
  <div id="map" style="height:70vh;border-radius:12px;overflow:hidden"></div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
(async function () {
  const map = L.map('map').setView([39.8283,-98.5795], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
              {maxZoom:18, attribution:'&copy; OpenStreetMap'}).addTo(map);

  const res = await fetch("{% url 'cart.popularity_json' %}");
  const { data } = await res.json();

  const cacheKey='zip-geocode-cache-v1';
  const gc = JSON.parse(localStorage.getItem(cacheKey)||'{}');

  async function geocode(z) {
    if (gc[z]) return gc[z];
    await new Promise(r=>setTimeout(r,250)); // polite rate limit
    const u = new URL('https://nominatim.openstreetmap.org/search');
    u.searchParams.set('postalcode', z); u.searchParams.set('country','USA');
    u.searchParams.set('format','json'); u.searchParams.set('limit','1');
    const r = await fetch(u); const a = await r.json();
    gc[z] = (a && a[0]) ? [parseFloat(a[0].lat), parseFloat(a[0].lon)] : null;
    localStorage.setItem(cacheKey, JSON.stringify(gc));
    return gc[z];
  }

  for (const row of data) {
    const loc = await geocode(row.zip);
    if (!loc) continue;
    const radius = Math.max(6, Math.min(20, 6 + row.total));
    const popup = `
      <div style="min-width:220px">
        <div class="fw-bold">ZIP ${row.zip}</div>
        <div class="text-muted small">Total purchases: ${row.total}</div>
        <ol class="mb-0">${row.top.map(t=>`<li>${t.movie_name} <span class="text-muted">(${t.total})</span></li>`).join('')}</ol>
      </div>`;
    L.circleMarker(loc,{radius,weight:1,opacity:.9,fillOpacity:.6}).addTo(map).bindPopup(popup);
  }
})();
</script>
{% endblock %}
